<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reporte — BiblioTecITTJ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
@media print{
  .no-print{ display:none!important; }
}
h1 small{ font-size:.6em; color:#666; }
</style>
</head>
<body class="p-4">
  <div class="no-print mb-3">
    <a href="app.html" class="btn btn-secondary btn-sm">← Volver</a>
    <button class="btn btn-primary btn-sm" onclick="window.print()">Imprimir / Guardar PDF</button>
  </div>
  <header class="d-flex align-items-center mb-4">
    <img src="./logo.png" alt="logo" style="height:48px" class="me-3">
    <div>
      <h1 class="h3 m-0">Reporte <span id="repTitle"></span></h1>
      <small id="repSub"></small>
    </div>
  </header>
  <table class="table table-bordered table-sm">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
<script>
function qs(k){ return new URLSearchParams(location.search).get(k) }
const type = qs('type')||'loans';
const title = {loans:'Préstamos', fines:'Multas', inventory:'Inventario'}[type]||'Préstamos';
document.getElementById('repTitle').textContent = '— '+title;
document.getElementById('repSub').textContent = new Date().toLocaleString();
const headers = {
  loans:['ID','Estudiante','Libro','Prestado','Vence','Devuelto','Multa'],
  fines:['ID','Préstamo','Estudiante','Libro','Monto','Estado','Creada','Pagada'],
  inventory:['ID','Título','Autor','ISBN','Año','Ejemplares']
};
document.getElementById('thead').innerHTML = '<tr>'+headers[type].map(h=>'<th>'+h+'</th>').join('')+'</tr>';

(async ()=>{
  let rows=[];
  if(type==='inventory'){
    const txt = await fetch('./api/reports.php?type=inventory', {credentials:'include'}).then(r=>r.text());
    rows = parseCSV(txt).slice(1); // skip header
  }else if(type==='fines'){
    const txt = await fetch('./api/reports.php?type=fines', {credentials:'include'}).then(r=>r.text());
    rows = parseCSV(txt).slice(1);
  }else{
    const txt = await fetch('./api/reports.php?type=loans', {credentials:'include'}).then(r=>r.text());
    rows = parseCSV(txt).slice(1);
  }
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = rows.map(r=>'<tr>'+r.map(c=>'<td>'+escapeHtml(c)+'</td>').join('')+'</tr>').join('');
})();

function parseCSV(text){
  // Simple CSV parser
  const lines = text.trim().split(/\r?\n/);
  return lines.map(l=>{
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<l.length;i++){
      const ch=l[i];
      if(ch=='"'){ q=!q; continue; }
      if(ch==',' && !q){ out.push(cur); cur=''; } else { cur+=ch; }
    }
    out.push(cur);
    return out;
  });
}
function escapeHtml(s){ return s.replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m])) }
</script>
</body>
</html>
